# 「御剑·灵枢」—— 基于手势交互的沉浸式剑阵操控系统

> **Slogan**：以手为引，万剑归宗

## 一、项目概述

「御剑·灵枢」（Sword Array Conductor）是一个融合东方仙侠美学与前沿交互技术的创新项目。系统通过普通 RGB 摄像头捕捉用户的手部动作，利用 MediaPipe 实现毫秒级 3D 手势识别，再将手势语义实时传输至 Unity 引擎，驱动物理仿真的飞剑阵列响应用户操控——实现"以手御剑"的沉浸式体验。

项目灵感源自中国道家阵法文化（《诛仙剑阵》《北斗七星阵》等），将"剑阵"这一经典仙侠意象转化为可交互的实时系统，让用户通过自然手势完成"启阵→布阵→御剑→破阵"的完整操控旅程。

### 目标用户

| 群体 | 场景 |
|------|------|
| 国风文化爱好者 | 沉浸式仙侠体验 |
| 科技极客 / 开发者 | 手势交互技术探索 |
| 沉浸式体验馆 | 线下互动展项 |
| 文化教育场景 | 博物馆数字化展览 |

### 差异化价值

将「中国剑阵文化」与「毫米级手势识别」结合的实时物理仿真系统，超越传统体感游戏的浅层交互，实现从"创造→操控→毁灭"的完整心流体验。

---

## 二、系统架构

系统采用三层架构设计，Python 手势引擎与 Unity 剑阵系统通过 WebSocket 实时通信：

```
┌─────────────────────────────────────────────────────────┐
│                    表现层 (Unity)                         │
│   剑体渲染 · PBR材质 · 剑气特效 · 阵法视觉 · HUD界面      │
├─────────────────────────────────────────────────────────┤
│                    仿真层 (Unity)                         │
│   剑体物理 · 阵法引擎 · 阶段状态机 · 事件总线             │
├──────────────────────┬──────────────────────────────────┤
│   WebSocket 通信层    │  msgpack / JSON · 60Hz · 双向     │
├──────────────────────┴──────────────────────────────────┤
│                    感知层 (Python)                        │
│   摄像头采集 · MediaPipe追踪 · 手势状态机 · 组合/双手检测   │
└─────────────────────────────────────────────────────────┘
```

---

## 三、技术栈

### Python 手势引擎

| 技术 | 版本要求 | 用途 |
|------|----------|------|
| Python | 3.9+ | 引擎运行时 |
| MediaPipe | ≥ 0.10.0 | 21点 3D 手部关键点追踪 |
| OpenCV | ≥ 4.8.0 | 摄像头采集与图像预处理 |
| websockets | ≥ 12.0 | WebSocket 服务端 |
| NumPy | ≥ 1.24.0 | 向量运算与信号处理 |
| msgpack | ≥ 1.0.0 | 高效二进制序列化 |
| PyYAML | ≥ 6.0 | 配置文件解析 |

### Unity 剑阵系统

| 技术 | 用途 |
|------|------|
| Unity 2020.3+ | 3D 渲染与物理引擎 |
| C# | 游戏逻辑编写 |
| WebSocket (NativeWebSocket) | 接收手势数据 |
| EventBus 模式 | 子系统间解耦通信 |

---

## 四、项目目录结构

```
yujian/
├── python-gesture-engine/       # Python 手势识别引擎
│   ├── main.py                  # 主入口：采集→追踪→识别→发送循环
│   ├── config.yaml              # 全局配置（摄像头/手势阈值/网络）
│   ├── hand_landmarker.task     # MediaPipe 手部模型文件
│   ├── requirements.txt         # Python 依赖清单
│   ├── capture/                 # 摄像头采集与帧预处理
│   │   ├── camera_source.py     # 摄像头初始化与帧读取
│   │   └── frame_preprocessor.py# 镜像翻转、RGB转换
│   ├── tracking/                # 手部追踪
│   │   ├── hand_tracker.py      # MediaPipe HandLandmarker 封装
│   │   ├── hand_state.py        # HandState 数据类（关键点/速度/手指状态）
│   │   └── landmark_smoother.py # One Euro Filter 关键点平滑
│   ├── gestures/                # 手势识别
│   │   ├── gesture_types.py     # GestureEvent / GestureState 数据定义
│   │   ├── gesture_state_machine.py # 手势状态机（激活/持续/冷却）
│   │   ├── atomic_gestures.py   # 5种原子手势检测器
│   │   ├── combo_detector.py    # 组合手势（如 抓取→推 = 发射）
│   │   └── dual_hand_gestures.py# 双手协同手势（启阵/破阵/布阵/万剑归宗）
│   ├── network/                 # 网络通信
│   │   ├── ws_server.py         # WebSocket 服务端（广播模式）
│   │   ├── protocol.py          # 消息类型与手势类型枚举
│   │   └── message_builder.py   # 消息序列化构建器
│   └── debug/                   # 调试工具
│       ├── visualizer.py        # OpenCV 可视化（关键点/手势标签）
│       └── logger.py            # 日志/FPS计数/延迟追踪
│
├── unity-sword-system/          # Unity 剑阵系统
│   └── Assets/
│       ├── Scenes/
│       │   └── YuJianMain.unity # 主场景
│       ├── Scripts/
│       │   ├── Core/            # 核心框架
│       │   │   ├── GameManager.cs    # 顶层编排器（单例）
│       │   │   ├── PhaseController.cs# 阶段状态机
│       │   │   ├── EventBus.cs       # 发布/订阅事件总线
│       │   │   └── InputBridge.cs    # 手势数据→Unity输入桥接
│       │   ├── Network/         # 网络层
│       │   │   ├── WebSocketClient.cs    # WebSocket 客户端
│       │   │   ├── MessageDeserializer.cs# 消息反序列化
│       │   │   └── GestureDataBuffer.cs  # 线程安全数据缓冲
│       │   ├── Sword/           # 剑体系统
│       │   │   ├── SwordController.cs    # 单剑控制器
│       │   │   ├── SwordPhysics.cs       # 剑体物理（力/轨迹）
│       │   │   ├── SwordPool.cs          # 对象池管理
│       │   │   └── SwordMeshGenerator.cs # 动态剑体网格
│       │   ├── Formation/       # 阵法系统
│       │   │   └── FormationManager.cs   # 阵型管理与切换
│       │   └── UI/              # 界面
│       │       ├── HUDController.cs      # 主HUD（阶段/手势/连接状态）
│       │       ├── TutorialOverlay.cs    # 90秒引导教学
│       │       └── DebugPanel.cs         # 调试面板
│       ├── Shaders/             # 自定义着色器
│       └── Materials/           # 材质资源
│
├── shared/                      # 共享定义
│   └── protocol/
│       └── messages.md          # 通信协议规范文档
│
├── tools/                       # 工具脚本
│   ├── gesture_recorder.py      # 手势录制工具
│   └── latency_benchmark.py     # 延迟基准测试
│
├── docs/                        # 文档目录
└── yujian.txt                   # 产品设计文档
```

---

## 五、Python 手势引擎详解

### 5.1 主循环流程

引擎入口为 `python-gesture-engine/main.py`，启动后进入以下实时循环（目标 60Hz）：

```
摄像头采集帧 → 预处理(镜像/RGB转换) → MediaPipe手部追踪 → 关键点平滑
    → 原子手势检测 → 组合手势检测 → 双手手势检测 → 消息构建 → WebSocket广播
```

每帧同时记录各阶段延迟（tracking / gesture / loop），可按 `d` 键打印延迟统计，按 `q` 键退出。

### 5.2 手部追踪模块 (`tracking/`)

- **HandTracker**：封装 MediaPipe HandLandmarker Tasks API，支持最多 2 只手的 21 个 3D 关键点实时追踪
- **HandState**：核心数据类，封装单手的完整状态：
  - 21 个 3D 关键点坐标（归一化 0~1）
  - 掌心中心位置 (`palm_center`)
  - 掌心速度向量 (`palm_velocity`)
  - 掌心法向量 (`palm_normal`)
  - 五指伸展状态 (`finger_states`: 0=弯曲, 1=伸展)
  - 握拳判定 (`is_fist`)
  - 手性标识 (`handedness`: Left/Right)
  - 检测置信度 (`confidence`)
- **LandmarkSmoother**：基于 One Euro Filter 算法的关键点平滑器，减少原始坐标抖动，参数可通过 `config.yaml` 调节

### 5.3 手势识别体系 (`gestures/`)

手势识别采用分层设计，从底层原子手势到高层组合手势逐级构建：

#### 原子手势（5种）

| 手势 | 检测逻辑 | 关键参数 |
|------|----------|----------|
| **Grab（抓取）** | 指尖到掌心距离 < 阈值 且 弯曲手指数 ≥ 3 | `fingertip_palm_distance: 0.10` |
| **Push（推）** | 掌心法向量朝前 且 Z轴正向速度 > 阈值 | `min_velocity_z: 0.08` |
| **Pull（拉）** | 掌心法向量朝后 且 Z轴负向速度 > 阈值 | `min_velocity_z: -0.08` |
| **Rotate（旋转）** | 掌心角速度 > 阈值 且 持续帧数 ≥ 3 | `min_angular_velocity: 1.0` |
| **Pinch（捏合）** | 拇指与食指指尖距离 < 阈值 | `thumb_index_distance: 0.06` |

#### 组合手势

| 手势 | 触发序列 | 说明 |
|------|----------|------|
| **Launch（发射）** | Grab → Push | 抓取后推出，发射飞剑 |

组合手势通过 `ComboDetector` 检测，支持配置最大间隔时间（1.2秒）和冷却时间（0.3秒）。

#### 双手协同手势

| 手势 | 操作方式 | 用途 |
|------|----------|------|
| **Open Array（启阵）** | 双手靠近后缓缓拉开 | 开启剑阵，进入启阵阶段 |
| **Close Array（破阵）** | 双掌从远处快速合拢 | 收束飞剑，结束剑阵 |
| **Form Circle（布阵画圆）** | 左手画圆形轨迹 | 设定阵法半径与形状 |
| **Point Place（布阵定位）** | 右手食指伸出并前推 | 在指定位置布置飞剑 |
| **Wan Jian Gui Zong（万剑归宗）** | 双手握拳保持0.3秒后同时前推 | 终极技：所有飞剑汇聚一点 |

### 5.4 手势状态机 (`GestureStateMachine`)

每只手独立维护一个状态机，包含三个状态：

```
[无手势] ──(置信度>激活阈值)──→ [手势激活] ──(置信度<持续阈值)──→ [冷却中] ──→ [无手势]
                                    │                                    ↑
                                    └──(持续时间>最小时长)──→ 触发事件 ──┘
```

- 激活阈值：0.4（降低以提高灵敏度）
- 持续阈值：0.25
- 最小持续时长：0.05秒

---

## 六、Unity 剑阵系统详解

### 6.1 核心框架 (`Core/`)

- **GameManager**：顶层编排器（单例模式），负责初始化所有子系统：WebSocket 客户端、数据缓冲区、输入桥接、阶段控制器
- **EventBus**：发布/订阅事件总线，实现子系统间解耦通信。核心事件包括：
  - `PhaseChangedEvent`：阶段切换通知
  - `GestureDetectedEvent`：手势检测事件
  - `WanJianGuiZongEvent`：万剑归宗触发事件
- **PhaseController**：阶段状态机，管理完整的交互生命周期
- **InputBridge**：将 WebSocket 接收的手势数据桥接到 Unity 主线程

### 6.2 阶段状态机

系统定义了 5 个交互阶段，由手势或键盘快捷键触发切换：

```
[Idle 待机] ──(OpenArray手势/按1)──→ [KaiZhen 启阵] ──(3秒自动)──→ [BuZhen 布阵]
                                                                        │
                ┌───────────────────────────────────────────────────────┘
                │
                ├──(PointPlace手势/按3)──→ [YuJian 御剑] ──(CloseArray手势/按4)──→ [PoZhen 破阵]
                │                              │                                      │
                │                              └──(WanJian手势/按5)──→ 万剑归宗       │
                │                                                                     │
                └─────────────────────────────────────(2秒自动)──→ [Idle 待机] ←───────┘
```

调试快捷键：`1`=启阵 `2`=布阵 `3`=御剑 `4`=破阵 `5`=万剑归宗 `0`=回到待机

### 6.3 剑体系统 (`Sword/`)

- **SwordController**：单剑控制器，管理剑体的生命周期状态：
  - `Dormant`（休眠）→ `Summoning`（召唤中）→ `InFormation`（阵中）→ `FreeControl`（自由控制）→ `Returning`（归位）→ `Dissolving`（消散）
- **SwordPhysics**：物理驱动模块，将手势参数（掌心速度、手指张开度）映射为物理力场，控制剑体运动轨迹
- **SwordPool**：对象池管理，高效复用剑体实例
- **SwordMeshGenerator**：动态生成/修改剑体网格

### 6.4 阵法系统 (`Formation/`)

- **FormationManager**：管理不同剑阵的布局与切换
- 支持的阵型包括：两仪阵、七星阵、诛仙阵等
- 左手画圆控制阵型半径，右手点指定位布剑

### 6.5 网络层 (`Network/`)

- **WebSocketClient**：异步连接 `ws://localhost:8765`，持续接收 Python 引擎推送的手势数据
- **MessageDeserializer**：将二进制/JSON 数据反序列化为 `GestureFrame` 对象
- **GestureDataBuffer**：线程安全的环形缓冲区（容量 4 帧），供 Unity 主线程消费

### 6.6 UI 系统 (`UI/`)

- **HUDController**：主界面，显示当前阶段名称、检测到的手势、WebSocket 连接状态
- **TutorialOverlay**：90 秒引导教学系统，分步教授用户手势操作
- **DebugPanel**：技术调试面板，显示 FPS、追踪手数、手势置信度等

---

## 七、通信协议

### 7.1 协议概述

| 项目 | 说明 |
|------|------|
| 传输协议 | WebSocket (`ws://localhost:8765`) |
| 序列化格式 | msgpack（开发阶段可用 JSON） |
| 发送频率 | 最高 60Hz |
| 消息方向 | Python → Unity（主要），Unity → Python（配置/反馈） |

### 7.2 消息类型

| 类型ID | 名称 | 方向 | 说明 |
|--------|------|------|------|
| 1 | HAND_FRAME | Python→Unity | 手部追踪帧数据（主消息） |
| 2 | GESTURE_EVENT | Python→Unity | 独立手势事件 |
| 3 | PHASE_CHANGE | 双向 | 阶段切换通知 |
| 10 | HEARTBEAT | 双向 | 心跳保活 |
| 20 | CONFIG_UPDATE | Unity→Python | 配置参数更新 |

### 7.3 HAND_FRAME 消息结构

```json
{
    "v": 1,                          // 协议版本
    "seq": 12345,                    // 消息序列号
    "type": 1,                       // HAND_FRAME
    "t": 1234567890.123,             // 时间戳 (monotonic seconds)
    "hands": [{
        "id": "Right",               // "Left" | "Right"
        "landmarks": [[x,y,z], ...], // 21个3D关键点 (归一化 0~1)
        "palm_pos": [x, y, z],       // 掌心中心位置
        "palm_vel": [vx, vy, vz],    // 掌心速度 (单位/秒)
        "palm_normal": [nx, ny, nz], // 掌心法向量
        "fingers": [1, 1, 1, 1, 1],  // 五指伸展状态
        "confidence": 0.95
    }],
    "gestures": [{
        "type": 2,                   // 手势类型ID
        "hand": "Right",
        "confidence": 0.92,
        "params": { ... }            // 手势特定参数
    }],
    "phase": 3                       // 当前交互阶段
}
```

### 7.4 手势类型枚举

| ID | 名称 | 说明 | params 字段 |
|----|------|------|-------------|
| 0 | NONE | 无手势 | - |
| 1 | GRAB | 抓取 | `duration` |
| 2 | PUSH | 推 | `force`, `direction` |
| 3 | PULL | 拉 | `force`, `direction` |
| 4 | ROTATE | 旋转 | `angular_velocity` |
| 5 | PINCH | 捏合 | `position` |
| 10 | LAUNCH | 发射（组合） | `combo_from` |
| 20 | OPEN_ARRAY | 启阵（双手） | `spread_distance`, `duration` |
| 21 | CLOSE_ARRAY | 破阵（双手） | `closing_speed` |
| 22 | FORM_CIRCLE | 布阵画圆 | `center`, `radius` |
| 23 | POINT_PLACE | 布阵定位 | `position` |
| 30 | WAN_JIAN | 万剑归宗 | `fist_duration`, `push_velocity` |

### 7.5 交互阶段枚举

| ID | 名称 | 说明 |
|----|------|------|
| 0 | IDLE | 待机 |
| 1 | KAI_ZHEN | 启阵 |
| 2 | BU_ZHEN | 布阵 |
| 3 | YU_JIAN | 御剑 |
| 4 | PO_ZHEN | 破阵 |

---

## 八、交互设计（用户旅程）

| 阶段 | 手势操作 | 系统反馈 | 情感设计 |
|------|----------|----------|----------|
| **启阵** | 双手合十后缓缓拉开 | 剑匣开启光效 + 古琴泛音 | 仪式感营造 |
| **布阵** | 左手画圆（控制阵型半径），右手食指点击（定点布剑） | 剑影沿轨迹飞入，每柄剑入位时有"铮"鸣 | 掌控感强化 |
| **御剑** | 单指滑动（控制单剑轨迹），五指张开（群体扩散），抓取+推（发射飞剑） | 剑尖拖尾光效随速度变化 | 流畅性体验 |
| **破阵** | 双掌快速合拢 | 所有飞剑螺旋收束至掌心，爆发环形冲击波 | 高潮情绪释放 |
| **万剑归宗** | 双手握拳保持后同时前推 | 全部飞剑汇聚一点，终极爆发 | 极致震撼 |

设计目标：通过"三步引导教学"（启阵→布阵→御剑）将用户上手时间控制在 90 秒内。

---

## 九、快速启动

### 9.1 启动 Python 手势引擎

```bash
cd python-gesture-engine
pip install -r requirements.txt
python main.py
```

启动后将打开摄像头窗口，显示手部关键点和手势标签。WebSocket 服务端监听 `ws://localhost:8765`。

### 9.2 启动 Unity 剑阵系统

1. 使用 Unity 2020.3+ 打开 `unity-sword-system` 项目
2. 打开场景 `Assets/Scenes/YuJianMain.unity`
3. 确保 Python 引擎已启动
4. 点击 Play，Unity 将自动连接 WebSocket 服务端

### 9.3 调试操作

| 操作 | 说明 |
|------|------|
| Python 窗口按 `q` | 退出手势引擎 |
| Python 窗口按 `d` | 打印各阶段延迟统计 |
| Unity 中按 `1~5` | 键盘触发对应阶段/技能 |
| Unity 中按 `0` | 回到待机状态 |

---

## 十、配置说明

所有手势引擎参数集中在 `python-gesture-engine/config.yaml` 中，主要配置项：

| 配置区域 | 关键参数 | 说明 |
|----------|----------|------|
| `camera` | `device_index`, `width`, `height`, `fps`, `flip_horizontal` | 摄像头设备与分辨率 |
| `tracking` | `max_hands`, `detection_confidence`, `tracking_confidence` | 手部追踪灵敏度 |
| `tracking.smoother` | `min_cutoff`, `beta` | One Euro Filter 平滑参数 |
| `gestures.grab` | `fingertip_palm_distance`, `min_curl_fingers` | 抓取手势阈值 |
| `gestures.push/pull` | `min_velocity_z`, `palm_facing_threshold` | 推/拉速度与方向阈值 |
| `gestures.rotate` | `min_angular_velocity`, `sustain_frames` | 旋转角速度与持续帧数 |
| `gestures.pinch` | `thumb_index_distance` | 捏合距离阈值 |
| `gestures.dual_hand` | `palms_together_distance`, `open_distance`, `close_velocity` | 双手手势距离与速度 |
| `gestures.dual_hand.wan_jian` | `push_velocity`, `fist_hold_time` | 万剑归宗触发参数 |
| `gestures.state_machine` | `activation_threshold`, `sustain_threshold`, `min_duration` | 状态机灵敏度 |
| `network` | `host`, `port`, `send_rate` | WebSocket 服务端地址与发送频率 |
| `debug` | `show_visualization`, `show_fps`, `show_landmarks`, `log_level` | 调试可视化开关 |

---

## 十一、关键设计亮点

1. **手势语义分层**：从 5 种原子手势 → 组合手势 → 双手协同手势，逐层构建丰富的交互语义
2. **物理驱动仿真**：剑体具有真实物理属性（质量、速度、空气阻力），手势参数直接映射为物理力场
3. **解耦架构**：Python 引擎与 Unity 系统通过 WebSocket 完全解耦，可独立开发和调试
4. **事件驱动**：Unity 端采用 EventBus 发布/订阅模式，子系统间零耦合
5. **可配置性**：所有手势阈值、追踪参数均可通过 YAML 配置文件调节，无需修改代码
6. **实时性保障**：60Hz 数据推送频率，One Euro Filter 平滑算法，端到端延迟控制在毫秒级
